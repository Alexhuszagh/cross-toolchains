FROM ubuntu:20.04
ARG DEBIAN_FRONTEND=noninteractive

COPY common.sh lib.sh /
RUN /common.sh

COPY cmake.sh /
RUN /cmake.sh

COPY xargo.sh /
RUN /xargo.sh

# run these in separate steps, so we can cache MSVC between all images.
COPY cross-toolchains/docker/msvc-wine.sh /
RUN /msvc-wine.sh

COPY wine.sh /
RUN /wine.sh

# need windows-style perl for paths
COPY cross-toolchains/docker/perl.sh /
RUN /perl.sh

ENV MSVC_ARCH=arm64
COPY cross-toolchains/docker/msvc-wine-symlink.sh /
RUN /msvc-wine-symlink.sh $MSVC_ARCH

COPY cross-toolchains/docker/msvc-windows-entry.sh /
COPY cross-toolchains/docker/msvc-env.sh /
ENTRYPOINT ["/msvc-windows-entry.sh"]

ENV CARGO_TARGET_AARCH64_PC_WINDOWS_MSVC_LINKER=link.exe \
    CC_aarch64_pc_windows_msvc=cl.exe \
    CXX_aarch64_pc_windows_msvc=cl.exe \
    PATH=/opt/msvc/bin/$MSVC_ARCH:/opt/bin:$PATH \
    WINEPATH="$WINEPATH;C:/windows/syswow64;C:/windows/system32;/opt/msvc/bin/$MSVC_ARCH"
